fn _start_agent
	# start ssh-agent and setup environment
	echo 'Starting ssh-agent...'
	let out = $(ssh-agent -s $or($ssh_agent_lifetime '') $or($ssh_agent_lifetime ''))
    let out = $regex_replace($out '^echo' '#echo')
    let out = $regex_replace($out '^([A-Z_]*)=(\.*)' 'let \1 = \2')
    echo $out > $_ssh_env_cache
	chmod 600 $_ssh_env_cache
	source $_ssh_env_cache > /dev/null
}

# Get the filename to store/lookup the environment from
let _ssh_env_cache = "$HOME/.ssh/environment-$SHORT_HOST"

# test if agent-forwarding is enabled
if bool $ssh_agent_agent_forwarding && test -n $SSH_AUTH_SOCK
	# Add a nifty symlink for screen/tmux if agent forwarding
	if not test -L $SSH_AUTH_SOCK
        ln -sf $SSH_AUTH_SOCK /tmp/ssh-agent-$USER-screen
    end
else if test -f $_ssh_env_cache
	# Source SSH settings, if applicable
	source $_ssh_env_cache > /dev/null
	if eq $USER "root"
		FILTER="ax"
	else
		FILTER="x"
	end
	if not ps $FILTER | grep ssh-agent | grep -q $SSH_AGENT_PID
		_start_agent
	end
else
	_start_agent
end

# check for .ssh folder presence
if not test -d $HOME/.ssh
    return
end

let identities ?= []
let loaded_sigs loaded_ids not_loaded = [] [] []

# add default keys if no identities were set up via zstyle
# this is to mimic the call to ssh-add with no identities
if eq $len(@identities) 0
    # key list found on `ssh-add` man page's DESCRIPTION section
    for id in id_rsa id_dsa id_ecdsa id_ed25519 identity
        # check if file exists
        if test -f "$HOME/.ssh/$id"
            let identities += $id
        end
    end
end

# get list of loaded identities' signatures and filenames
for line in @split($(ssh-add -l) '\n')
    let loaded_sigs += @split($line ' ')[1]
    let loaded_ids += @split($line ' ')[2]
end

# add identities if not already loaded
for id, i in $identities
    # check for filename match, otherwise try for signature match
    if contains $id @loaded_ids
        let sig = $(ssh-keygen -lf "$HOME/.ssh/$id" | awk '{print $2}')
        if contains $sig @loaded_sigs
            let not_loaded += "$HOME/.ssh/$id"
        end
    end
end

if not eq 0 $len(@not_loaded)
    ssh-add @not_loaded
end
