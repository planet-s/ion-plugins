# Get the filename to store/lookup the environment from
let _ssh_env_cache = "$HOME/.ssh/environment-$or($SHORT_HOST '')"

fn _start_agent
	# start ssh-agent and setup environment
	echo 'Starting ssh-agent...'
    let ssh_agent_lifetime ?= ''
	let out = $(ssh-agent -s $ssh_agent_lifetime $ssh_agent_lifetime)
    let out = $regex_replace($out '^echo' '#echo')
    let out = $regex_replace($out '^([A-Z_]*)=(\.*)' 'let \1 = \2')
    echo $out > $_ssh_env_cache
	chmod 600 $_ssh_env_cache
	source $_ssh_env_cache > /dev/null
end

# test if agent-forwarding is enabled
if exists -s ssh_agent_agent_forwarding && bool $ssh_agent_agent_forwarding && exists -s env::SSH_AUTH_SOCK
	# Add a nifty symlink for screen/tmux if agent forwarding
	if not test -L $SSH_AUTH_SOCK
        ln -sf $SSH_AUTH_SOCK /tmp/ssh-agent-$USER-screen
    end
else if test -f $_ssh_env_cache
	# Source SSH settings, if applicable
	source $_ssh_env_cache > /dev/null
    let FILTER = ""
	if eq $USER "root"
		let FILTER = "ax"
	else
		let FILTER = "x"
	end
	if not ps $FILTER | grep ssh-agent | grep -q $SSH_AGENT_PID
		_start_agent
	end
else
	_start_agent
end

# check for .ssh folder presence
if not test -d $HOME/.ssh
    return
end

let identities ?= []
let loaded_sigs loaded_ids not_loaded = [] [] []

# add default keys if no identities were set up via zstyle
# this is to mimic the call to ssh-add with no identities
if eq $len(@identities) 0
    # key list found on `ssh-add` man page's DESCRIPTION section
    for id in id_rsa id_dsa id_ecdsa id_ed25519 identity
        # check if file exists
        if test -f "$HOME/.ssh/$id"
            let identities += $id
        end
    end
end

# get list of loaded identities' signatures and filenames
for line in @split($(ssh-add -l) '\n')
    let loaded_sigs ::= @split($line ' ')[1]
    let loaded_ids ::= @split($line ' ')[2]
end

# add identities if not already loaded
for id in @identities
    # check for filename match, otherwise try for signature match
    if contains $id @loaded_ids
        let sig = $(ssh-keygen -lf "$HOME/.ssh/$id" | awk '{print $2}')
        if contains $sig @loaded_sigs
            let not_loaded += "$HOME/.ssh/$id"
        end
    end
end

if not eq 0 $len(@not_loaded)
    ssh-add @not_loaded
end
if exists -s ssh_agent_agent_forwarding
  drop ssh_agent_agent_forwarding
end
if exists -s ssh_agent_lifetime
  drop ssh_agent_lifetime
end
drop _ssh_env_cache
